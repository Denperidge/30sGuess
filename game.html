<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheet.css">
    <script src="jquery-3.2.1.min.js"></script>
    <script src="functions.js"></script>
    <style>
      #timer
      {
        width: 200px;
        margin: auto;

        padding: 25px;

        border: 1px solid #191414;

        color: #FFFFFF;
        text-align: center;
        font-size: 18px;

        background-color: #1DB954;
      }

      #time
      {
        font-size: 50px;
      }

      fieldset
      {
        width: 60vw;
        margin: auto;

        padding: 10px;
      }

      .clickable
      {
        cursor: pointer;
        cursor: hand;
      }
    </style>
  </head>
  <body>
    <div id="header">
      Minigames for <img src="Spotify_Logo_RGB_White.png" alt="Spotify"/>
      <p id="logOut" onclick="logOut();">Log out</p>
    </div>

    <div id="body" style="margin-left:50px">
      <br><br><br>
      <div id="timer">
        <b id="timerTitle"></b>
        <p id="time"></p>
      </div>

      <fieldset id="answer">
        <legend>Answer</legend>
        <select id="names"></select>
        by
        <select id="artists"></select>
        <button onclick="Submit();">Submit!</button>
        <input id="vol-control" type="range" min="0" max="100" step="1" oninput="SetVolume(this.value)" onchange="SetVolume(this.value)"></input>
      </fieldset>
    </div>


    <div id="footer">
      <b>Developed by <a href="https://github.com/StijnDotExe/">StijnDotExe</a></b>
    </div>
  </body>

  <script>
    // [START] External functions (not made by me)
    function optionExists(val, id) {
        return $("#" + id + " option").filter(function() {
           return this.value === val;
         }).length !== 0;
    }

    function rng(min, max) {
      return Math.floor(Math.random() * (max - min) ) + min;
    }

    function SetVolume(val)
    {
      localStorage.setItem("volume", val);
      try
      {
        currentAudio.volume = val / 100;
      }
      catch (e) {}  // If no audio is playing, just save the audiolevel

    }
    // [END] External functions

    var countdown;

    function SetUpForNewRound()
    {
      document.getElementById("vol-control").value = localStorage.getItem("volume");
      document.getElementById("timerTitle").innerHTML = "Click here to start a new round!";
      document.getElementById("timer").setAttribute("class", "clickable");
      document.getElementById("timer").addEventListener("click", CountDown);
    }


    function CountDown()
    {
      document.getElementById("timer").removeEventListener("click", CountDown);
      document.getElementById("timer").setAttribute("class", null);
      document.getElementById("timerTitle").innerHTML = "Time until new round...";
      var time = document.getElementById("time");
      time.innerHTML = 3;
      countdown = setInterval(
        function()
        {
          time.innerHTML = parseInt(time.innerHTML) - 1;
          if (parseInt(time.innerHTML) <= 0) StartRound();
        }, 1000);
    }

    var currentName;
    var currentArtists;
    var currentAudio;

    function StartRound()
    {
      clearInterval(countdown);
      var currentIndex = rng(0, tracks.length);
      var currentTrack = tracks[currentIndex];
      currentName = currentTrack.name;
      currentArtists = [];
      for (var i = 0; i < currentTrack.artists.length; i++)
      {
        currentArtists.push(currentTrack.artists[i].name);
      }
      document.getElementById("timerTitle").innerHTML = "Guess the song that is currently playing!";
      //currentAudio = new Audio(currentTrack.preview_url);
      currentAudio = document.createElement("VIDEO");
      currentAudio.src = currentTrack.preview_url;
      SetVolume(document.getElementById("vol-control").value);
      currentAudio.play();
      StartTimer();
    }

    var timer;
    function StartTimer()
    {
      var time = document.getElementById("time");
      var timerbg = document.getElementById("timer");  // TimerBackGround
      time.innerHTML = 30;
      timer = setInterval(
        function(){
          time.innerHTML = parseInt(time.innerHTML) - 1;
          if (parseInt(time.innerHTML) < 20) timerbg.style.backgroundColor = "orange";
          if (parseInt(time.innerHTML) < 10) timerbg.style.backgroundColor = "red";
          if (time.innerHTML == 0) clearInterval(timer);
        }, 1000);
    }

    function Submit()
    {
      if (!currentAudio.paused)
      {
        var correctName = false;;
        var correctArtist = false;

        if (names[names.selectedIndex].text == currentName)
        {
          correctName = true;
          document.getElementById("timerTitle").innerHTML = "Correct name, ";
        }
        else {
          document.getElementById("timerTitle").innerHTML = "Incorrect name, ";
        }

        if ($.inArray(artists[artists.selectedIndex].text, currentArtists) != -1)
        {
          correctArtist = true;
          document.getElementById("timerTitle").innerHTML += "correct artist!";
        }
        else {
          document.getElementById("timerTitle").innerHTML += "incorrect artist!";
        }

        if (correctName && correctArtist)
        {
          currentAudio.pause();
          CountDown();
          clearInterval(timer);
        }
      }
    }

    var tracks = JSON.parse(localStorage.getItem("tracks"));
    console.log(tracks);

    var names = document.getElementById("names");
    var artists = document.getElementById("artists");
    for (var i = 0; i < tracks.length; i++)
    {
      if (!optionExists(tracks[i].name, "names"))
      {
        var nameOption = document.createElement("option");
        nameOption.text = tracks[i].name;
        names.add(nameOption);
      }

      for (var j = 0; j < tracks[i].artists.length; j++)
      {
        if (!optionExists(tracks[i].artists[j].name, "artists"))
        {
          var artistOption = document.createElement("option");
          artistOption.text = tracks[i].artists[j].name;
          artists.add(artistOption);
        }
      }
    }

    SetUpForNewRound();
  </script>
</html>
